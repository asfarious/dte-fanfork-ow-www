# Warrior Lodges decisions
# By Milla Isaksson

targeted_decisions = {
	duel_decision = {
		is_high_prio = yes
		diplomacy_icon = GFX_duel_decision
		ai_check_interval = 10

		only_playable = yes

		from_potential = {
			OR = {
				AND = {
					has_focus = focus_war
					has_dlc = "Way of Life"
				}

				AND = {
					has_dlc = "Holy Fury"

					OR = {
						is_member_of_any_warrior_lodge_trigger = yes

						any_bloodline = {
							has_bloodline_flag = duelist_bloodline
						}
					}
				}
			}

			is_adult = yes
			prisoner = no
			has_regent = no
			is_inaccessible_trigger = no

			trigger_if = {
				limit = {
					is_female = yes
					ai = yes
				}

				OR = {
					trait = brave
					religion_group = pagan_group
					is_nomadic = yes
					religion = buddhist
					religion = bogomilist
					gender_equality_trigger = yes
				}
			}
		}

		potential = {
			# Either you are both adults
			trigger_if = {
				limit = { is_adult = yes }
				FROM = { is_adult = yes }
			}
			# Or you are both children! WEIRD!
			trigger_else = {
				FROM = { is_adult = no }
			}

			prisoner = no
			NOT = { character = FROM }
			is_inaccessible_trigger = no
		}

		allow = {
			# Won't show ANY reqs. if you have "Unrestricted" duels...
			trigger_if = {
				limit = {
					NOT = {
						has_game_rule = {
							name = dueling
							value = unrestricted
						}
					}
				}

				# But otherwise: find a target, valid both relationship-, and healthwise...
				OR = {
					custom_tooltip = {
						text = duel_tooltip_rivals
						is_rival = FROM
					}

					custom_tooltip = {
						text = duel_tooltip_foes
						is_foe = FROM
					}

					trigger_if = {
						limit = { religion = FROM }

						custom_tooltip = {
							text = duel_tooltip_excommunicated
							FROM = { trait = zealous }
							trait = excommunicated
						}
					}

					trigger_if = {
						limit = { FROM = { religion_group = muslim } }

						custom_tooltip = {
							text = duel_tooltip_decadent
							FROM = { trait = zealous }
							trait = decadent
						}
					}

					trigger_if = {
						limit = {
							any_quester_targeting_this = { # FROM must have this as a quest target
								character = FROM

								OR = {
									has_quest = quest_warrior_lodge_duel_honor
									has_quest = quest_warrior_lodge_duel_deadly
								}
							}
						}

						custom_tooltip = {
							text = quest_target_tt
						}
					}
				}
			}

			# Both are healthy
			custom_tooltip = {
				text = duel_tooltip_sickness
				FROM = {
					NOR = { # Not in sickly in bed, but sick if well treated is okay
						has_character_modifier = bedridden_illness
						has_character_modifier = severe_illness
						is_incapable = yes
					}
				}
				ROOT = {
					NOR = { # Not in sickly in bed, but sick if well treated is okay
						has_character_modifier = bedridden_illness
						has_character_modifier = severe_illness
						is_incapable = yes
					}
				}
			}

			custom_tooltip = {
				text = duel_tooltip_pregnant
				FROM = { is_pregnant = no }
				ROOT = { is_pregnant = no }
			}

			####### You won't want to fight someone who is badly injured, and if you are hurt yourself, you will want to wait...
			custom_tooltip = {
				text = duel_tooltip_recent_duel

				FROM = { NOT = { has_character_modifier = recent_duel_timer } }
				NOT = { has_character_modifier = recent_duel_timer }
			}

			#############################################################################

			custom_tooltip = {
				text = duel_tooltip_no_war
				FROM = { war = no }
				war = no
			}

			# If you do not have this as your mission target, you need to be within diplo-range...
			trigger_if = {
				limit = {
					NOT = {
						any_quester_targeting_this = { # FROM must have this as a quest target
							character = FROM
							OR = {
								has_quest = quest_warrior_lodge_duel_honor
								has_quest = quest_warrior_lodge_duel_deadly
							}
						}
					}
				}
				is_within_diplo_range = FROM # CPU HEAVY!
			}

			trigger_if = {
				limit = { has_character_modifier = has_recently_declined_duel_cooldown }

				custom_tooltip = {
					text = opinion_duel_decline_cooldown_tt
					NOT = { has_character_modifier = has_recently_declined_duel_cooldown }
				}
			}
		}

		effect = {
			# REQUIRED event targets for setting up duel evaluation!
			FROM = { save_event_target_as = combatant_1 } # the person issuing the duel...
			save_event_target_as = combatant_2 # the target of the duel...

			apply_degree_of_dishonorable_duel_effect = yes # checks a bunch of age and health statuses...
			apply_any_applicable_harsh_penalties_effect = yes # if your target is someone

			FROM = {
				pacifists_lose_piety_effect = yes

				add_character_modifier = {
					modifier = recent_duel_timer
					days = 90
					hidden = yes
				}
			}

			hidden_effect = {
				character_event = { id = HFP.10095 } # Duel evaluation (hidden) + result event as follow-up
			}
		}

		ai_will_do = {
			factor = 0.1

			trigger = {
				# If the target has already declined a duel, AI's won't attempt to duel them while the timer is still
				NOT = { has_character_modifier = declined_prestige_duel_timer }
			}

			mult_modifier = {
				factor = 1.5
				FROM = { potentially_interested_in_rivaling_root_trigger = yes }
			}
		}
	}

	########################################
	# 				CLAIM duels 		   #
	########################################

	claim_duel_decision = {
		is_high_prio = yes
		diplomacy_icon = GFX_duel_decision

		ai_check_interval = 10

		only_playable = yes

		from_potential = {
			has_dlc = "Holy Fury"
			is_tribal = yes
			num_of_claims > 0
			is_adult = yes
			prisoner = no
			has_regent = no
			is_inaccessible_trigger = no

			trigger_if = {
				limit = {
					is_female = yes
					ai = yes
				}

				OR = {
					trait = brave
					religion_group = pagan_group
					is_nomadic = yes
					religion = buddhist
					religion = bogomilist
					gender_equality_trigger = yes
				}
			}
		}

		potential = {
			any_demesne_title = {
				FROM = {
					has_strong_claim = PREV

					NOR = {
						character = ROOT
						has_character_flag = claim_duel@ROOT
					}
				}
			}

			OR = {
				independent = yes
				same_liege = FROM
			}

			# Either you are both adults
			trigger_if = {
				limit = { is_adult = yes }
				FROM = { is_adult = yes }
			}
			# Or you are both children! WEIRD!
			trigger_else = {
				FROM = { is_adult = no }
			}

			prisoner = no
			is_inaccessible_trigger = no
		}

		allow = {
			### For CLAIM duels ###
			custom_tooltip = {
				text = both_tribal_tt
				is_tribal = yes
				FROM = { is_tribal = yes }
			}

			# Both are healthy
			custom_tooltip = {
				text = duel_tooltip_sickness
				FROM = {
					NOR = { # Not in sickly in bed, but sick if well treated is okay
						has_character_modifier = bedridden_illness
						has_character_modifier = severe_illness
						is_incapable = yes
					}
				}
				ROOT = {
					NOR = { # Not in sickly in bed, but sick if well treated is okay
						has_character_modifier = bedridden_illness
						has_character_modifier = severe_illness
						is_incapable = yes
					}
				}
			}

			custom_tooltip = {
				text = duel_tooltip_recent_duel

				FROM = { NOT = { has_character_modifier = recent_duel_timer } }
				NOT = { has_character_modifier = recent_duel_timer }
			}

			custom_tooltip = {
				text = duel_tooltip_recent_challenge_tt

				FROM = { NOT = { has_character_modifier = recently_challenged_rule_timer } }
			}

			custom_tooltip = {
				text = duel_tooltip_no_war

				FROM = { war = no }
				war = no
			}

			is_within_diplo_range = FROM # CPU HEAVY!

			trigger_if = {
				limit = { has_character_modifier = has_recently_declined_duel_cooldown }

				custom_tooltip = {
					text = opinion_duel_decline_cooldown_tt
					NOT = { has_character_modifier = has_recently_declined_duel_cooldown }
				}
			}
		}

		effect = {
			FROM = {
				show_scope_change = no

				set_character_flag = claim_duel@ROOT
				pacifists_lose_piety_effect = yes
		   		increase_troublemaker_status_effect = yes

				add_character_modifier = {
					modifier = recent_duel_timer
					days = 90
					hidden = yes
				}
			}

			apply_degree_of_dishonorable_duel_effect = yes # checks a bunch of age and health statuses...
			apply_any_applicable_harsh_penalties_effect = yes

			hidden_effect = {
				# REQUIRED event targets for setting up duel evaluation!
				FROM = { save_event_target_as = combatant_1 } # the person issuing the duel...
				save_event_target_as = combatant_2 # the target of the duel...

				if = { # If Challenger has more than one claim to fight for...
					limit = {
						any_demesne_title = {
							count > 1
							FROM = { has_strong_claim = PREV }
						}
					}

					random_demesne_title = {
						limit = { event_target:combatant_1 = { has_strong_claim = PREV } }
						preferred_limit = { tier = EMPEROR }
						preferred_limit = { tier = KING }
						preferred_limit = { tier = DUKE }
						preferred_limit = { tier = COUNT }
						preferred_limit = { tier = BARON }
						save_event_target_as = target_title
					}

					event_target:combatant_1 = {
						set_character_flag = wants_multiple_titles_from@event_target:combatant_2
					}
				}
				else = { # There is only ONE claim involved...
					random_demesne_title = {
						limit = { event_target:combatant_1 = { has_strong_claim = PREV } }
						save_event_target_as = target_title
					}

					event_target:combatant_1 = {
						set_character_flag = wants_single_title_from@event_target:combatant_2
					}
				}
				FROM = {
					add_character_modifier = {
						modifier = recently_challenged_rule_timer
						duration = 90
						hidden = yes
					}
				}

				character_event = {
					id = HF.10095 # Duel evaluation (hidden) + result event as follow-up
					days = 1
				}
			}
		}

		ai_will_do = {
			factor = 0.1

			trigger = {
				# If the target has already declined a duel, AI's won't attempt to duel them while the timer is still
				NOT = { has_character_modifier = declined_prestige_duel_timer }
			}

			mult_modifier = {
				factor = 1.1
				trait = brave
			}

			mult_modifier = {
				factor = 1.5
				trait = ambitious
			}

			title_tier_reduction_score = yes
		}
	}

	########################################

	### Recruit/Induct your child into your warrior lodge ###
	recruit_child_decision = {
		is_high_prio = yes
		diplomacy_icon = GFX_duel_decision
		ai_check_interval = 36

		only_playable = yes

		from_potential = {
			has_dlc = "Holy Fury"
			is_member_of_any_warrior_lodge_trigger = yes
			is_adult = yes
			prisoner = no
			has_regent = no
			is_inaccessible_trigger = no
		}

		potential = {
			is_child_of = FROM
			NOT = { character = FROM }
			prisoner = no

			trigger_if = {
				limit = { FROM = { ai = yes } }
				is_primary_heir = FROM
			}

			NOT = { has_character_flag = flag_child_abandoned_lodge }
		}

		allow = {
			age >= 12

			trigger_if = {
				limit = { # Can't be in a society already...
					is_in_society = yes

					NOR = { # except a secret one...
						society_member_of = secret_religious_cult
						is_devil_worshiper_trigger = yes
						society_member_of = the_assassins
					}
				}

				is_in_society = no
			}

			trigger_if = {
				limit = {
					OR = {
						has_character_flag = is_being_recruited_to_warrior_lodge_by_parent
						has_character_flag = refused_trial
					}
				}
				custom_tooltip = {
					text = already_attempted_recruitment_tt
					NOR = {
						has_character_flag = refused_trial
						has_character_flag = is_being_recruited_to_warrior_lodge_by_parent
					}
				}
			}

			trigger_if = {
				limit = {
					OR = { # Either you or the recruit have a bloodline that matters...
						FROM = {
							any_owned_bloodline = {
								has_bloodline_flag = bloodline_legendary_warrior
							}
						}

						any_owned_bloodline = {
							has_bloodline_flag = bloodline_legendary_warrior
						}

						custom_tooltip = {
							text = has_mission_to_recruit_tt

							FROM = {
								has_quest = quest_warrior_lodge_recruit
								quest_target = { character = ROOT }
							}
						}
					}
				}

				OR = {
					FROM = {
						show_scope_change = no
						has_society_currency_tiny_trigger = yes # It could cost currency...
					}

					custom_tooltip = {
						text = legendary_warrior_bloodline_trigger_tt
						OR = { # Or you or the recruit have a bloodline that matters...
							FROM = {
								any_owned_bloodline = {
									has_bloodline_flag = bloodline_legendary_warrior
								}
							}
							any_owned_bloodline = {
								has_bloodline_flag = bloodline_legendary_warrior
							}
						}
					}

					custom_tooltip = { # Or you have a mission to recruit ROOT...
						text = has_mission_to_recruit_tt
						FROM = {
							has_quest = quest_warrior_lodge_recruit
							quest_target = { character = ROOT }
						}
					}
				}
			}
			trigger_else = {
				FROM = {
					show_scope_change = no
					has_society_currency_tiny_trigger = yes # It could cost currency...
				}
			}

			is_inaccessible_trigger = no

			custom_tooltip = {
				text = characters_are_not_busy_tt

				FROM = {
					NOT = { has_character_flag = do_not_disturb }
					war = no
				}
				NOT = { has_character_flag = do_not_disturb }
				war = no
			}

			trigger_if = {
				limit = { NOT = { is_within_diplo_range = FROM } }
				is_within_diplo_range = FROM # CPU HEAVY!
			}

			trigger_if = { # If landed, target character must be tribal or nomadic
				limit = { is_landed = yes }

				ROOT = {
					OR = {
						has_tribal_or_nomadic_government_trigger = yes

						custom_tooltip = {
							text = has_mission_to_recruit_tt

							FROM = {
								has_quest = quest_warrior_lodge_recruit
								quest_target = { character = ROOT }
							}
						}
					}
				}
			}
			trigger_if = { #If landed, recruiting character must be tribal or nomadic
				limit = { FROM = { is_landed = yes } }

				FROM = {
					OR = {
						has_tribal_or_nomadic_government_trigger = yes

						custom_tooltip = {
							text = has_mission_to_recruit_tt

							has_quest = quest_warrior_lodge_recruit
							quest_target = { character = ROOT }
						}
					}
				}
			}
		}

		effect = {
			FROM = { save_event_target_as = recruiting_parent }

			if = {
				limit = {
					NOR = { #If no one has a bloodline that matters...
						FROM = {
							any_owned_bloodline = {
								has_bloodline_flag = bloodline_legendary_warrior
							}
						}

						any_owned_bloodline = {
							has_bloodline_flag = bloodline_legendary_warrior
						}

						custom_tooltip = {
							text = has_mission_to_recruit_tt

							FROM = {
								has_quest = quest_warrior_lodge_recruit
								quest_target = { character = ROOT }
							}
						}
					}
				}

				FROM = {
					show_scope_change = no
					detract_society_currency_tiny_effect = yes #It will cost currency...
				}
			}


			save_event_target_as = new_recruit
			set_character_flag = society_join_block
			set_character_flag = awaiting_initiation_trial
			set_character_flag = is_being_recruited_to_warrior_lodge_by_parent

			# Used later for joining correct society:
			FROM = {
				society = {
					save_event_target_as = warrior_lodge_to_join
				}
			}

			hidden_effect = {
				character_event = { id = HF.10016 } # Find opponent to fight
			}
		}

		ai_will_do = {
			factor = 1
		}
	}

	##############################
	########## POWERS ############
	##############################

	# Power, rank 4: Choose Military Aspect
	choose_military_aspect = {
		filter = self
		ai_target_filter = self
		ai_check_interval = 12

		is_in_society = yes

		potential = {
			has_dlc = "Holy Fury"
			is_member_of_any_warrior_lodge_trigger = yes
			society_rank == 4
			is_adult = yes
		}

		allow = {
			has_society_currency_minor_trigger = yes

			custom_tooltip = {
				text = choose_military_aspect_allow_tt
				NOT = { has_character_flag = choosing_military_aspect }
			}

			OR = {
				custom_tooltip = {
					text = does_not_have_a_lifestyle_trait_tt
					lifestyle_traits < 1
				}

				trait = duelist
				trait = hunter
				trait = strategist
			}
		}

		effect = {
			hidden_effect = {
				set_character_flag = choosing_military_aspect

				if = {
					limit = { has_lifestyle_martial_trigger = yes }
					character_event = { id = HF.10020 } # Choose which trait to replace your current with...!
				}

				if = {
					limit = { lifestyle_traits < 1 }
					character_event = { id = HF.10021 } # Choose a path to go down...
				}
			}

			detract_society_currency_minor_effect = yes
		}

		ai_will_do = {
			factor = 1

			trigger = {
				lifestyle_traits < 1
			}
		}
	}

	# Power, rank 2: Gain Lodge-specific Commander trait
	warrior_training = {
		filter = self
		ai_target_filter = self
		ai_check_interval = 12

		is_in_society = yes
		only_playable = yes

		potential = {
			has_dlc = "Holy Fury"
			is_member_of_any_warrior_lodge_trigger = yes
			society_rank >= 2
			is_adult = yes
			NOT = { has_character_flag = choosing_warrior_training } # to stop you spamming the button
			has_current_warrior_lodge_leader_trait_trigger = no # to keep it hidden once you're done
		}

		allow = {
			has_society_currency_medium_trigger = yes

			custom_tooltip = {
				text = has_no_warrior_training_with_current_society_tt
				has_current_warrior_lodge_leader_trait_trigger = no
			}
		}

		effect = {
			detract_society_currency_medium_effect = yes

			hidden_effect = {
				set_character_flag = choosing_warrior_training
				character_event = { id = HF.10040 } # Gain trait...
			}
		}


		ai_will_do = {
			factor = 1

			trigger = {
				lifestyle_traits < 1
			}

			mult_modifier = {
				factor = 0.1
				has_religion_matching_joined_warrior_lodge_trigger = no
			}
		}
	}

	# Power, rank 1 (Bon only): Toughness
	warrior_toughness = {
		filter = self
		ai_target_filter = self
		ai_check_interval = 12

		is_in_society = yes
		only_playable = yes

		potential = {
			has_dlc = "Holy Fury"
			society_member_of = warrior_lodge_bon
			society_rank = 1
			is_adult = yes
			NOT = { has_character_flag = using_toughness } # to stop you spamming the button
		}

		allow = {
			has_society_currency_minor_trigger = yes
			has_religion_matching_joined_warrior_lodge_trigger = yes

			custom_tooltip = {
				text = not_already_using_toughness_tt
				NOT = { has_character_flag = using_toughness }
			}

			OR = {
				trait = wounded
				trait = severely_injured
				trait = maimed
				trait = mangled
				trait = infection
			}
		}

		effect = {
			detract_society_currency_minor_effect = yes

			hidden_effect = {
				set_character_flag = using_toughness
				character_event = { id = HF.10055 } # Remove physical injury...
			}
		}

		ai_will_do = {
			factor = 1

			trigger = {
				NOT = { trait = depressed }
			}

			mult_modifier = {
				factor = 1.5
				in_command = yes
			}
		}
	}

	# Power, rank 1 (Norse only): Go Berserk
	warrior_lodge_norse_go_berserk = {
		filter = self
		ai_target_filter = self
		ai_check_interval = 12

		is_in_society = yes
		only_playable = yes

		potential = {
			has_dlc = "Holy Fury"
			society_member_of = warrior_lodge_norse
			society_rank = 1
			is_adult = yes
			NOT = { has_character_flag = going_berserk } # to stop you spamming the button
		}

		allow = {
			has_society_currency_minor_trigger = yes
			has_religion_matching_joined_warrior_lodge_trigger = yes

			custom_tooltip = {
				text = not_already_going_berserk_tt
				NOT = { has_character_flag = going_berserk }
			}

			OR = {
				NOT = { trait = berserker }
				prisoner = yes
			}
		}

		effect = {
			if = {
				limit = { NOT = { trait = berserker } }

				# Specifies what the trait gives: must be updated if trait is
				custom_tooltip = {
					text = gain_berserker_tt
				}
			}

			set_character_flag = special_berserker # Will last for at least 10 years

			hidden_effect = {
				if = {
					limit = { trait = patient }
					remove_trait = patient
				}
				else_if = {
					limit = { NOT = { trait = wroth } }
					add_trait = wroth
				}

				if = {
					limit = { trait = defensive_leader }
					remove_trait = defensive_leader
				}

				if = {
					limit = {
						leader_traits < 1
						NOT = { trait = aggressive_leader }
					}
					add_trait = aggressive_leader
				}

				if = {
					limit = { prisoner = no }
					character_event = { id = HF.10056 } # Go berserk!
				}
				else = { # Might break you out of prison or have something bonkers happen...
					character_event = { id = HF.10070 } # Go berserk in prison!
				}
			}
			set_character_flag = going_berserk
			detract_society_currency_minor_effect = yes
		}

		ai_will_do = {
			factor = 1

			mult_modifier = {
				factor = 0.1
				trait = shy
			}

			mult_modifier = {
				factor = 0.1
				trait = craven
			}

			mult_modifier = {
				factor = 0.1
				trait = patient
			}

			mult_modifier = {
				factor = 0.1
				trait = defensive_leader
			}
		}
	}

	#Power, rank 4: Call to Glory
	warrior_lodge_call_to_glory = {
		is_high_prio = yes
		is_mercenary = yes

		filter = self
		ai_target_filter = self
		ai_check_interval = 12

		is_in_society = yes
		only_playable = yes

		potential = {
			has_dlc = "Holy Fury"
			is_member_of_any_warrior_lodge_trigger = yes
			society_rank = 4
			is_adult = yes
			NOT = { has_character_modifier = call_to_glory }

			trigger_if = {
				limit = { ai = yes }

				any_war = {
					OR = {
						is_primary_war_defender = yes
						is_primary_war_attacker = yes
					}
				}
			}
		}

		allow = {
			war = yes
			in_command = yes
			has_society_currency_major_trigger = yes
		}

		effect = {
			detract_society_currency_major_effect = yes

			custom_tooltip = {
				text = tooltip_lodge_call_to_glory

				set_variable = {
					which = call_to_glory_variable
					value = 0
				}

				# First recurring event
				character_event = { id = HF.25030 }

				# Removed by recurring event and on_action when at peace or if leaving society
				add_character_modifier = {
					modifier = call_to_glory
					duration = -1
				}
			}
		}

		ai_will_do = {
			factor = 0 # decisions with the "is_mercenary" will not be calculated from the script
		}
	}
}

society_decisions = {
	warrior_lodge_legendary_gathering = {
		ai_check_interval = 36
		is_high_prio = yes

		only_playable = yes

		potential = {
			has_dlc = "Holy Fury"
			is_member_of_any_warrior_lodge_trigger = yes
			society_rank == 4
			is_adult = yes

			trigger_if = {
				limit = { society_has_active_progress = yes }

				society = {
					had_flag = {
						flag = used_legendary_gathering
						years >= 100
					}
				}
			}
		}

		allow = {
			has_society_currency_major_trigger = yes
			is_inaccessible_trigger = no

			custom_tooltip = {
				text = legendary_gathering_cd_tt

				society = {
					trigger_if = {
						limit = { has_flag = used_legendary_gathering }

						had_flag = {
							flag = used_legendary_gathering
							years >= 100
						}
					}
				}
			}
		}

		effect = {
			detract_society_currency_major_effect = yes

			custom_tooltip = {
				text = legendary_gathering_tt
				sound_effect = pagan_warhorn


				society = {
					if = {
						limit = {
							had_flag = {
								flag = used_legendary_gathering
								years >= 100
							}
						}
						clr_flag = used_legendary_gathering
					}

					# Needs to be checked (should stick 100 years)
					set_flag = used_legendary_gathering

					clr_flag = block_society_progress

					if = {
						limit = {
							society_has_active_progress = yes

							had_flag = {
								flag = used_legendary_gathering
								years >= 100
							}
						}
						set_society_progress = 0
					}

					start_society_progress = yes
				}
			}
		}

		ai_will_do = {
			factor = 0.1

			mult_modifier = {
				factor = 1.5 # more likely if ambitious
				OR = {
					trait = ambitious
					ai_ambition >= 50
				}
			}

			mult_modifier = {
				factor = 0.1
				any_bloodline = { always = yes } # Less likely if already has a bloodline...
			}

			mult_modifier = {
				factor = 0.1
				duelist_skill_is_high_group_trigger = no # Less likely if AI is not a great duelist...
			}

			mult_modifier = {
				factor = 0.1 # Less likely if irrational
				ai_rationality < 0
			}
		}
	}

	warrior_lodge_summon_commander = {
		ai_check_interval = 36

		only_playable = yes

		potential = {
			has_dlc = "Holy Fury"
			is_member_of_any_warrior_lodge_trigger = yes
			society_rank = 2
			is_adult = yes
		}

		allow = {
			has_society_currency_medium_trigger = yes
			is_inaccessible_trigger = no
		}

		effect = {
			detract_society_currency_medium_effect = yes

			custom_tooltip = {
				text = tooltip_summoning_lodge_commander

				trigger_switch = {
					on_trigger = has_religion_feature

					religion_matriarchal = {
						create_random_soldier = {
							random_traits = yes
							dynasty = random
							female = yes

							attributes = {
								diplomacy = 4
								learning = 4
								stewardship = 4
								intrigue = 4
								martial = 14
							}
						}
					}

					religion_patriarchal = {
						create_random_soldier = {
							random_traits = yes
							dynasty = random
							female = no

							attributes = {
								diplomacy = 4
								learning = 4
								stewardship = 4
								intrigue = 4
								martial = 14
							}
						}
					}

					fallback = {
						if = {
							limit = {
								has_game_rule = {
									name = gender
									value = all
								}
							}

							create_random_soldier = {
								random_traits = yes
								dynasty = random
								female = 50

								attributes = {
									diplomacy = 4
									learning = 4
									stewardship = 4
									intrigue = 4
									martial = 14
								}
							}
						}
						else = {
							create_random_soldier = {
								random_traits = yes
								dynasty = random
								female = 5

								attributes = {
									diplomacy = 4
									learning = 4
									stewardship = 4
									intrigue = 4
									martial = 14
								}
							}
						}
					}
				}

				new_character = {
					remove_trait = weak
					remove_trait = slow
					remove_trait = imbecile
					remove_trait = dull
					remove_trait = mystic
					remove_trait = socializer
					remove_trait = gamer
					remove_trait = hedonist
					remove_trait = duelist
					remove_trait = hunter
					remove_trait = strategist
					remove_trait = administrator
					remove_trait = architect
					remove_trait = gardener
					remove_trait = schemer
					remove_trait = impaler
					remove_trait = seducer
					remove_trait = seductress
					remove_trait = theologian
					remove_trait = scholar

					if = {
						limit = {
							is_female = yes

							ROOT = {
								NOR = {
									has_religion_feature = religion_matriarchal
									has_religion_feature = religion_patriarchal
									has_game_rule = {
										name = gender
										value = all
									}
								}
							}
						}
						set_character_flag = special_marshal # Ensures character can be marshal
					}

					random_list = { # Flavor Randomization
						35 = {
							# Nothing
						}
						15 = {
							change_martial = 2
						}
						10 = {
							add_trait = robust
						}
						10 = {
							add_trait = duelist
						}
						10 = {
							add_trait = hunter
						}
						5 = {
							add_trait = strategist
						}
						5 = {
							change_martial = 4
						}
						5 = {
							if = {
								limit = { has_dlc = "Reapers" }
								add_trait = one_eyed
							}
						}
						5 = {
							add_trait = shrewd
						}
						3 = {
							add_trait = giant
						}
					}

					join_prev_warrior_lodge_society_effect = yes

					hidden_effect = {
						random = {
							# Chance of the commander being spawned from another religion
							chance = 50

							give_this_warrior_lodge_religion_effect = yes

							#In which case don't allow liege to immediately demand conversion.
							set_character_flag = ai_flag_refuse_conversion
						}

						add_warrior_lodge_leader_trait_effect = yes

						if = {
							limit = { has_dharmic_religion_trigger = yes }

							add_trait = kshatriya
							character_event = { id = RoI.30121 }
						}

						else_if = {
							limit = {
								OR = {
									religion = hellenic_pagan
									religion = hellenic_pagan_reformed
									has_religion_feature = religion_astrology
								}
							}

							add_western_zodiac_trait_effect = yes
						}

						if = {
							limit = {
								religion_group = pagan_group
								has_religion_feature = religion_no_leader
							}

							random_list = {
								5  = { add_trait = pagan_branch_1 }
								25 = { add_trait = pagan_branch_2 }
								25 = { add_trait = pagan_branch_3 }
								25 = { add_trait = pagan_branch_4 }
							}
						}
					}

					set_character_flag = invited_lodge_soldier
					set_character_flag = lodge_warrior_original_court_@ROOT
					set_character_flag = no_court_invites
					save_event_target_as = invited_lodge_soldier
				}
			}
			character_event = { id = HF.25000 } # Notify, give commander title, etc.
		}

		ai_will_do = {
			factor = 0.1

			trigger = {
				# Only use if empty commander spots
				trigger_if = {
					limit = { is_nomadic = yes }

					trigger_if = {
						limit = { tier = KING }

						has_assigned_minor_title = {
							title = title_commander
							count < 2
						}
					}
					trigger_else_if = {
						limit = { tier = EMPEROR }

						has_assigned_minor_title = {
							title = title_commander
							count < 4
						}
					}
				}
				trigger_else = {
					trigger_if = {
						limit = { tier = COUNT }

						has_assigned_minor_title = {
							title = title_commander
							count < 2
						}
					}
					trigger_else_if = {
						limit = { tier = DUKE }

						has_assigned_minor_title = {
							title = title_commander
							count < 4
						}
					}
					trigger_else_if = {
						limit = { tier = KING }

						has_assigned_minor_title = {
							title = title_commander
							count < 6
						}
					}
					trigger_else_if = {
						limit = { tier = EMPEROR }

						has_assigned_minor_title = {
							title = title_commander
							count < 8
						}
					}
				}
			}

			mult_modifier = {
				factor = 0.5
				war = no # Only summon in time of need
			}

			mult_modifier = {
				factor = 0.1
				# Less likely to invite if there is already someone else at court
				any_courtier = { is_member_of_any_warrior_lodge_trigger = yes }
			}

			mult_modifier = {
				factor = 0.1
				job_marshal = {
					martial >= 16
				}
			}

			mult_modifier = {
				factor = 0.25 # Fearful to be challenged for leadership
				is_tribal = yes
				trait = paranoid
			}
		}
	}

	warrior_lodge_suomenusko_summon_warriors = {
		ai_check_interval = 20
		is_high_prio = yes
		is_mercenary = yes

		only_playable = yes

		potential = {
			has_dlc = "Holy Fury"
			society_member_of = warrior_lodge_finnish
			society_rank = 3

			OR = {
				religion = finnish_pagan
				religion = finnish_pagan_reformed
			}

			is_adult = yes

			trigger_if = {
				limit = { ai = yes }

				any_war = {
					OR = {
						is_primary_war_defender = yes
						is_primary_war_attacker = yes
					}
				}
			}
		}

		allow = {
			war = yes
			has_society_currency_medium_trigger = yes
			is_inaccessible_trigger = no

			custom_tooltip = {
				text = tooltip_has_not_already_summoned_ukko_warriors
				NOT = { has_character_modifier = lodge_summon_warriors_cooldown }
			}
		}

		effect = {
			detract_society_currency_medium_effect = yes

			character_event = { id = HF.25001 }

			custom_tooltip = {
				text = tooltip_summon_warriors_ukko

				# Removed on_action when player is back at peace.
				add_character_modifier = {
					modifier = lodge_summon_warriors_cooldown
					duration = -1
					hidden = yes
				}
			}
		}

		ai_will_do = {
			factor = 0 # decisions with the "is_mercenary" will not be calculated from the script
		}
	}

	warrior_lodge_slavic_stand_together = {
		ai_check_interval = 20
		is_high_prio = yes
		is_mercenary = yes

		only_playable = yes

		potential = {
			has_dlc = "Holy Fury"
			society_member_of = warrior_lodge_slavic
			society_rank = 2

			OR = {
				religion = slavic_pagan
				religion = slavic_pagan_reformed
			}

			is_adult = yes

			trigger_if = {
				limit = { ai = yes }
				any_war = {
					OR = {
						is_primary_war_defender = yes
						is_primary_war_attacker = yes
					}
				}
			}
		}

		allow = {
			war = yes
			has_society_currency_medium_trigger = yes
			is_inaccessible_trigger = no

			custom_tooltip = {
				text = tooltip_has_not_already_stood_together_slavic
				NOT = { has_character_modifier = lodge_slavic_stand_together_cooldown }
			}

			custom_tooltip = {
				text = tooltip_stand_together_candidate_exists

				any_society_member = {
					is_ruler = no
					religion = ROOT
					is_incapable = yes
					is_inaccessible_trigger = no
					in_command = no

					host = {
						ai = yes
						NOT = { character = ROOT }
					}

					NOR = {
						is_heir = ROOT
						has_minor_title = title_commander
						has_job_title = job_marshal
					}
				}
			}
		}

		effect = {
			detract_society_currency_medium_effect = yes

			custom_tooltip = {
				text = tooltip_slavic_stand_together

				character_event = { id = HF.25007 } # Find society member

				add_character_modifier = {
					modifier = lodge_slavic_stand_together_cooldown
					duration = -1 #Removed on_action when player is back at peace.
					hidden = yes
				}
			}
		}

		ai_will_do = {
			factor = 0 # decisions with the "is_mercenary" will not be calculated from the script
		}
	}

	warrior_lodge_tengri_call_of_the_steppe = {
		ai_check_interval = 50
		is_high_prio = yes

		only_playable = yes

		potential = {
			has_dlc = "Holy Fury"
			society_member_of = warrior_lodge_tengri
			society_rank = 2
			is_adult = yes

			OR = {
				religion = tengri_pagan
				religion = tengri_pagan_reformed
			}
		}

		allow = {
			has_society_currency_minor_trigger = yes
			is_inaccessible_trigger = no

			trigger_if = {
				limit = { is_nomadic = yes }

				custom_tooltip = {
					text = tooltip_call_of_the_steppe_cooldown

					NOR = {
						has_character_modifier = lodge_call_of_the_steppe_boost
						has_character_flag = flag_using_call_of_the_steppes
					}
				}
			}
		}

		effect = {
			detract_society_currency_minor_effect = yes

			if = {
				limit = { is_nomadic = yes }

				custom_tooltip = {
					text = tooltip_call_of_the_steppe_nomad

					character_event = { id = HF.25004 } # Give reward
				}
			}
			else = {
				custom_tooltip = {
					text = tooltip_call_of_the_steppe_feudal

					character_event = { id = HF.25005 } # Give reward
					set_character_flag = flag_using_call_of_the_steppes
				}
			}
		}

		ai_will_do = {
			factor = 0.1

			trigger = {
				trigger_if = {
					limit = { is_nomadic = yes }
					war = no # No need for levy reinforcement for non-nomads when at peace
				}

				# I could use some help winning this war
				any_war = {
					is_primary_war_defender = yes
					war_score < 50
				}
			}

			mult_modifier = {
				factor = 0.5
				trait = stubborn
			}

			mult_modifier = { # I am losing the war, help!
				factor = 10
				any_war = {
					is_primary_war_defender = yes
					war_score < -50
				}
			}

			mult_modifier = {
				factor = 4
				war = yes
			}

			mult_modifier = {
				factor = 2
				trait = zealous
			}

			mult_modifier = {
				factor = 3
				trait = ambitious
			}
		}
	}

	warrior_lodge_war_sacrifice = {
		ai_check_interval = 6

		is_in_society = yes
		only_playable = yes

		potential = {
			has_dlc = "Holy Fury"
			is_member_of_any_warrior_lodge_trigger = yes
			society_rank >= 3
			is_adult = yes

			trigger_if = {
				limit = { ai = yes }

				any_war = {
					OR = {
						is_primary_war_defender = yes
						is_primary_war_attacker = yes
					}
				}
			}
		}
		allow = {
			has_society_currency_medium_trigger = yes
			is_inaccessible_trigger = no
			is_incapable = no

			custom_tooltip = {
				text = tooltip_war_sacrifice_cooldown

				NOR = {
					has_character_modifier = lodge_war_sacrifice_cooldown
					has_character_flag = flag_picking_war_sacrifice
				}
			}
		}

		effect = {
			detract_society_currency_medium_effect = yes

			custom_tooltip = {
				text = tooltip_lodge_war_sacrifice

				set_character_flag = flag_picking_war_sacrifice
				character_event = { id = HF.25021 }
			}
		}

		ai_will_do = {
			factor = 0.1

			trigger = {
				war = yes

				trigger_if = {
					limit = {
						trait = zealous
						religion_group = pagan_group
					}

					NOR = {
						religion = hellenic_pagan
						religion = bon
					}
				}
			}

			mult_modifier = {
				factor = 0.5
				trait = stubborn
			}

			mult_modifier = {
				factor = 1.5
				has_religion_matching_joined_warrior_lodge_trigger = no
			}

			mult_modifier = {
				factor = 0.5
				trait = craven
			}

			mult_modifier = { # I am losing the war, help!
				factor = 10
				any_war = {
					is_primary_war_defender = yes
					war_score < -50
				}
			}

			mult_modifier = { # I am winning the war, no need!
				factor = 0.25
				any_war = {
					is_primary_war_defender = yes
					war_score > 50
				}
			}

			mult_modifier = {
				factor = 2
				trait = zealous
				religion_group = pagan_group
			}

			mult_modifier = {
				factor = 3
				trait = brave
			}

			mult_modifier = {
				factor = 3
				has_religion_feature = religion_haruspicy
			}

			mult_modifier = {
				factor = 5
				has_religion_feature = religion_ritual_sacrifice
			}
		}
	}

	warrior_lodge_zun_battle_trance = {
		ai_check_interval = 12

		only_playable = yes

		potential = {
			has_dlc = "Holy Fury"
			society_member_of = warrior_lodge_zun
			society_rank >= 2
			is_adult = yes

			OR = {
				religion = zun_pagan
				religion = zun_pagan_reformed
			}
		}

		allow = {
			has_society_currency_minor_trigger = yes
			is_inaccessible_trigger = no
			is_incapable = no

			custom_tooltip = {
				text = tooltip_zun_battle_trance_cooldown

				NOR = {
					has_character_modifier = lodge_zun_battle_trance_1
					has_character_modifier = lodge_zun_battle_trance_2
					has_character_modifier = lodge_zun_battle_trance_3
					has_character_flag = flag_picking_battle_trance
				}
			}
		}

		effect = {
			detract_society_currency_minor_effect = yes

			custom_tooltip = {
				text = tooltip_zun_battle_trance

				set_character_flag = flag_picking_battle_trance
				character_event = { id = HF.25006 }
			}
		}

		ai_will_do = {
			factor = 0.1

			trigger = {
				war = yes
				is_ill = no
				NOT = { trait = craven }

				# I could use some help winning this war
				any_war = {
					is_primary_war_defender = yes
					war_score < 50
				}
			}

			mult_modifier = {
				factor = 0.5
				trait = stubborn
			}

			mult_modifier = { # I am losing the war, help!
				factor = 10
				any_war = {
					is_primary_war_defender = yes
					war_score < -50
				}
			}

			mult_modifier = {
				factor = 2
				trait = zealous
			}

			mult_modifier = {
				factor = 3
				trait = brave
			}
		}
	}

	warrior_lodge_west_african_create_fetish = {
		is_high_prio = yes
		ai_check_interval = 150

		only_playable = yes

		potential = {
			has_dlc = "Holy Fury"
			society_member_of = warrior_lodge_west_african
			society_rank = 4
			is_adult = yes

			OR = {
				religion = west_african_pagan
				religion = west_african_pagan_reformed
			}

			trigger_if = {
				limit = {
					ai = yes
					is_landed = no
				}

				NOT = {
   					any_artifact = {
   						has_artifact_flag = mask
   					}
   				}
			}
		}

		allow = {
			trigger_if = {
				limit = { ai = no }
				has_society_currency_major_trigger = yes
			}

			is_inaccessible_trigger = no
			is_incapable = no

			custom_tooltip = {
				text = tooltip_west_african_create_fetish_cooldown

				# Removed upon ending of event chain
				NOT = { has_character_flag = flag_ordered_fetish_creation }
			}

			custom_tooltip = {
				text = tooltip_has_african_mask_duplicate

   				NAND = {
   					any_artifact = {
   						has_artifact_flag = mask
   					}

					any_artifact = {
   						has_artifact_flag = totem
   					}
   				}
   			}
		}

		effect = {
			if = {
				limit = { ai = no }
				detract_society_currency_major_effect = yes
			}

			custom_tooltip = {
				text = tooltip_west_african_create_fetish

				if = {
					limit = {
						ai = yes
						is_landed = no

						NOT = {
							any_artifact = {
								has_artifact_flag = mask
							}
						}
					}
					generate_mask_effect = yes
				}

				else = {
					set_character_flag = flag_ordered_fetish_creation

					character_event = { id = HF.25040 }
				}
			}
		}

		ai_will_do = {
			factor = 1

			mult_modifier = {
				factor = 0.5
				trait = stubborn
			}

			mult_modifier = {
				factor = 5
				trait = ambitious
			}

			mult_modifier = {
				factor = 5
				trait = zealous
			}

			mult_modifier = {
				factor = 2
				war = yes
			}
		}
	}
}

decisions = {
	# Create Hellenic Warrior Lodge - Dead at start
	create_warrior_lodge_hellenic = {
		is_high_prio = yes
		ai_check_interval = 120

		only_playable = yes

		potential = {
			has_dlc = "Holy Fury"

			NOR = {
				has_global_flag = flag_restored_warrior_lodge_hellenic
				has_religion_feature = religion_peaceful

				has_alternate_start_parameter = {
					key = religion_names
					value = random
				}
			}

			OR = {
				religion = hellenic_pagan
				religion = hellenic_pagan_reformed
			}

			warrior_lodge_hellenic = {
				society_has_members = no
			}

			is_adult = yes
		}

		allow = {
			higher_tier_than = DUKE
			has_education_martial_trigger = yes
			martial >= 15
			scaled_wealth = 0.75
			prestige >= 1500
			is_in_society = no
			is_incapable = no
			is_inaccessible_trigger = no
		}

		effect = {
			scaled_wealth = -0.75
			prestige = -1500

			custom_tooltip = {
				text = create_warrior_lodge_hellenic_tooltip

				set_global_flag = flag_restored_warrior_lodge_hellenic
				join_society = warrior_lodge_hellenic
				set_society_grandmaster = yes
				add_society_currency_massive_effect = yes

				while = {
					count = 6

					spawn_good_commander_effect = yes
					new_character = { join_society = warrior_lodge_hellenic }
				}

				any_vassal = {
					limit = {
						ai = yes
						can_join_society = warrior_lodge_hellenic
					}

					random = {
						chance = 75
						join_society = warrior_lodge_hellenic
					}
				}

				any_neighbor_independent_ruler = {
					limit = {
						ai = yes
						can_join_society = warrior_lodge_hellenic
					}

					random = {
						chance = 35
						join_society = warrior_lodge_hellenic
					}
				}

				any_player = {
					limit = {
						OR = {
							religion = hellenic_pagan_reformed
							religion = hellenic_pagan
							culture = roman
							is_within_diplo_range = ROOT
						}
					}
					narrative_event = { id = HF.25026 } # Chance to join
				}
			}
		}

		ai_will_do = {
			factor = 1
		}
	}
}

settlement_decisions = {
	# Power, rank 3: Inspire Warriors
	warrior_lodge_inspire_warriors = {
		ai_check_interval = 80
		filter = owned
		ai_target_filter = owned

		is_in_society = yes
		only_playable = yes

		from_potential = {
			has_dlc = "Holy Fury"
			is_member_of_any_warrior_lodge_trigger = yes
			society_rank >= 3
			higher_tier_than = BARON
			NOT = { has_character_flag = inspiring_warriors }
		}

		potential = {
			holder = FROM
		}

		allow = {
			FROM = {
				show_scope_change = no
				has_society_currency_minor_trigger = yes
			}

			# Holding does not have a full garrison or levy
			holding_total_levy_percent < 1
		}

		effect = {
			save_event_target_as = target_holding

			FROM = {
				show_scope_change = no
				set_character_flag = inspiring_warriors
				detract_society_currency_minor_effect = yes
				character_event = { id = HF.10059 }	# Handle actual effect
			}
		}


		ai_will_do = {
			factor = 1

			trigger = {
				FROM = {
					# If I am not at war, who cares!
					war = yes

					# I could use some help winning this war
					any_war = {
						is_primary_war_defender = yes
						war_score < 50
					}
				}
			}

			modifier = { # I am losing the war, help!
				factor = 1.5
				any_war = {
					is_primary_war_defender = yes
					war_score < -50
				}
			}
		}
	}

	# Power, rank 3: Baltic Holds
	warrior_lodge_romuva_baltic_holds = {
		ai_check_interval = 80
		filter = owned
		ai_target_filter = owned
		is_high_prio = yes

		is_in_society = yes
		only_playable = yes

		from_potential = {
			has_dlc = "Holy Fury"
			society_member_of = warrior_lodge_baltic
			society_rank >= 3
			is_nomadic = no
			is_adult = yes
			higher_tier_than = BARON

			OR = {
				religion = baltic_pagan
				religion = baltic_pagan_reformed
			}
		}

		potential = {
			holder = FROM

			trigger_if = {
				limit = { holding_type = tribal }

				NAND = {
					OR = {
						has_building = tb_hillfort_4
						is_building = tb_hillfort_4
					}
					OR = {
						has_building = tb_defensive_fortifications_4
						is_building = tb_defensive_fortifications_4
					}
				}
			}

			trigger_else = {
				holding_type = castle

				NAND = {
					OR = {
						has_building = ca_wall_5
						is_building = ca_wall_5
						has_building = ca_con_wall_6
						is_building = ca_con_wall_6
					}
					OR = {
						has_building = ca_wall_q_5
						is_building = ca_wall_q_5
					}
				}
			}
		}

		allow = { # Now it's going to get ugly...
		#	show_only_failed_conditions = yes

			FROM = { has_society_currency_minor_trigger = yes }

			trigger_if = {
				trigger = { holding_type = tribal }

				# Prioritize hillfort first, as is more important
				trigger_if = {
					limit = {
						NOR = {
							has_building = tb_hillfort_4
							is_building = tb_hillfort_4
						}
					}

					OR = {
						custom_tooltip = {
							text = tooltip_can_build_tb_hillfort_1

							# location = { TECH_CASTLE_CONSTRUCTION >= 0 }

							NOR = {
								is_building = tb_hillfort_1
								has_building = tb_hillfort_1
							}
						}

						custom_tooltip = {
							text = tooltip_can_build_tb_hillfort_2

							has_building = tb_hillfort_1
							# location = { TECH_CASTLE_CONSTRUCTION >= 0 }

							NOR = {
								is_building = tb_hillfort_2
								has_building = tb_hillfort_2
							}
						}

						custom_tooltip = {
							text = tooltip_can_build_tb_hillfort_3

							has_building = tb_hillfort_2
							location = { TECH_CASTLE_CONSTRUCTION >= 1 }

							NOR = {
								is_building = tb_hillfort_3
								has_building = tb_hillfort_3
							}
						}

						custom_tooltip = {
							text = tooltip_can_build_tb_hillfort_4

							has_building = tb_hillfort_3
							location = { TECH_CASTLE_CONSTRUCTION >= 1 }

							NOR = {
								is_building = tb_hillfort_4
								has_building = tb_hillfort_4
							}
						}
					}
				}
				trigger_else_if = {
					limit = {
						NOR = {
							is_building = tb_defensive_fortifications_4
							has_building = tb_defensive_fortifications_4
						}
					}

					OR = {
						custom_tooltip = {
							text = tooltip_can_build_tb_defensive_fortifications_1

							# location = { TECH_CASTLE_CONSTRUCTION >= 0 }

							NOR = {
								is_building = tb_defensive_fortifications_1
								has_building = tb_defensive_fortifications_1
							}
						}

						custom_tooltip = {
							text = tooltip_can_build_tb_defensive_fortifications_2

							has_building = tb_defensive_fortifications_1
							# location = { TECH_CASTLE_CONSTRUCTION >= 0 }

							NOR = {
								is_building = tb_defensive_fortifications_2
								has_building = tb_defensive_fortifications_2
							}
						}

						custom_tooltip = {
							text = tooltip_can_build_tb_defensive_fortifications_3

							has_building = tb_defensive_fortifications_2
							location = { TECH_CASTLE_CONSTRUCTION >= 1 }

							NOR = {
								is_building = tb_defensive_fortifications_3
								has_building = tb_defensive_fortifications_3
							}
						}

						custom_tooltip = {
							text = tooltip_can_build_tb_defensive_fortifications_4

							has_building = tb_defensive_fortifications_3
							location = { TECH_CASTLE_CONSTRUCTION >= 1 }

							NOR = {
								is_building = tb_defensive_fortifications_4
								has_building = tb_defensive_fortifications_4
							}
						}
					}
				}
			}
			trigger_else_if = {
				limit = { holding_type = castle }

				trigger_if = {
					limit = {
						NOR = {
							has_building = ca_wall_5
							is_building = ca_wall_5
						}
					}

					# Prioritize walls first, as they give more benefits
					custom_tooltip = {
						text = tooltip_can_build_ca_wall_1

						trigger_if = {
							limit = {
								NOR = {
									is_building = ca_wall_1
									has_building = ca_wall_1
								}
							}
							# location = { TECH_FORTIFICATIONS_CONSTRUCTION >= 0 }
						}
						trigger_else_if = {
							limit = {
								has_building = ca_wall_1

								NOR = {
									is_building = ca_wall_2
									has_building = ca_wall_2
								}
							}

							location = { TECH_FORTIFICATIONS_CONSTRUCTION >= 2 }
						}
						trigger_else_if = {
							limit = {
								has_building = ca_wall_2

								NOR = {
									is_building = ca_wall_3
									has_building = ca_wall_3
								}
							}

							location = { TECH_FORTIFICATIONS_CONSTRUCTION >= 4 }
						}
						trigger_else_if = {
							limit = {
								has_building = ca_wall_3

								NOR = {
									is_building = ca_wall_4
									has_building = ca_wall_4
								}
							}

							location = { TECH_FORTIFICATIONS_CONSTRUCTION >= 6 }
						}
						trigger_else = {
							has_building = ca_wall_4
							location = { TECH_FORTIFICATIONS_CONSTRUCTION >= 8 }
						}
					}
				}

				trigger_else_if = {
					limit = {
						NOR = {
							is_building = ca_wall_q_5
							has_building = ca_wall_q_5
						}
					}

					custom_tooltip = {
						text = tooltip_can_build_ca_wall_q_1

						trigger_if = {
							limit = {
								NOR = {
									is_building = ca_wall_q_1
									has_building = ca_wall_q_1
								}
								# location = { TECH_FORTIFICATIONS_CONSTRUCTION >= 0 }
							}
						}
						trigger_else_if = {
							limit = {
								has_building = ca_wall_q_1

								NOR = {
									is_building = ca_wall_q_2
									has_building = ca_wall_q_2
								}
							}

							location = { TECH_FORTIFICATIONS_CONSTRUCTION >= 1 }
						}
						trigger_else_if = {
							limit = {
								has_building = ca_wall_q_2

								NOR = {
									is_building = ca_wall_q_3
									has_building = ca_wall_q_3
								}
							}

							location = { TECH_FORTIFICATIONS_CONSTRUCTION >= 3 }
						}
						trigger_else_if = {
							limit = {
								has_building = ca_wall_q_3

								NOR = {
									is_building = ca_wall_q_4
									has_building = ca_wall_q_4
								}
							}

							location = { TECH_FORTIFICATIONS_CONSTRUCTION >= 5 }
						}
						trigger_else = {
							has_building = ca_wall_q_4
							location = { TECH_FORTIFICATIONS_CONSTRUCTION >= 7 }
						}
					}
				}
			}
		}

		effect = {
			FROM = {
				show_scope_change = no

				detract_society_currency_minor_effect = yes

				hidden_effect = {
					random_list = {
						33 = { sound_effect = baltic_holds_01 }
						33 = { sound_effect = baltic_holds_02 }
						33 = { sound_effect = baltic_holds_03 }
					}
				}
			}

			if = {
				limit = { holding_type = castle }

				if = {
					limit = {
						NOR = {
							has_building = ca_wall_5
							is_building = ca_wall_5
						}
					}

					if = {
						limit = {
							has_building = ca_wall_4
							location = { TECH_FORTIFICATIONS_CONSTRUCTION >= 8 }
						}

						add_building = ca_wall_5

						hidden_effect = {
							FROM = {
								character_event = { id = HF.25068 } # Notify
							}
						}
					}
					else_if = {
						limit = {
							has_building = ca_wall_3
							NOT = { is_building = ca_wall_4 }
							location = { TECH_FORTIFICATIONS_CONSTRUCTION >= 6 }
						}

						add_building = ca_wall_4

						hidden_effect = {
							FROM = {
								character_event = { id = HF.25068 } # Notify
							}
						}
					}
					else_if = {
						limit = {
							has_building = ca_wall_2
							NOT = { is_building = ca_wall_3 }
							location = { TECH_FORTIFICATIONS_CONSTRUCTION >= 4 }
						}

						add_building = ca_wall_3

						hidden_effect = {
							FROM = {
								character_event = { id = HF.25068 } # Notify
							}
						}
					}
					else_if = {
						limit = {
							has_building = ca_wall_1
							NOT = { is_building = ca_wall_2 }
							location = { TECH_FORTIFICATIONS_CONSTRUCTION >= 2 }
						}

						add_building = ca_wall_2

						hidden_effect = {
							FROM = {
								character_event = { id = HF.25068 } # Notify
							}
						}
					}
					else_if = {
						limit = {
							NOR = {
								is_building = ca_wall_1
								has_building = ca_wall_1
							}
							# location = { TECH_FORTIFICATIONS_CONSTRUCTION >= 0 }
						}

						add_building = ca_wall_1

						hidden_effect = {
							FROM = {
								character_event = { id = HF.25068 } # Notify
							}
						}
					}
				}
				else_if = {
					limit = {
						NOR = {
							has_building = ca_wall_q_5
							is_building = ca_wall_q_5
						}
					}

					if = {
						limit = {
							has_building = ca_wall_q_4
							location = { TECH_FORTIFICATIONS_CONSTRUCTION >= 7 }
						}

						add_building = ca_wall_q_5

						hidden_effect = {
							FROM = {
								character_event = { id = HF.25069 } # Notify
							}
						}
					}
					else_if = {
						limit = {
							has_building = ca_wall_q_3
							NOT = { is_building = ca_wall_q_4 }
							location = { TECH_FORTIFICATIONS_CONSTRUCTION >= 5 }
						}

						add_building = ca_wall_q_4

						hidden_effect = {
							FROM = {
								character_event = { id = HF.25069 } # Notify
							}
						}
					}
					else_if = {
						limit = {
							has_building = ca_wall_q_2
							NOT = { is_building = ca_wall_q_3 }
							location = { TECH_FORTIFICATIONS_CONSTRUCTION >= 3 }
						}

						add_building = ca_wall_q_3

						hidden_effect = {
							FROM = {
								character_event = { id = HF.25069 } # Notify
							}
						}
					}
					else_if = {
						limit = {
							has_building = ca_wall_q_1
							NOT = { is_building = ca_wall_q_2 }
							location = { TECH_FORTIFICATIONS_CONSTRUCTION >= 1 }
						}

						add_building = ca_wall_q_2

						hidden_effect = {
							FROM = {
								character_event = { id = HF.25069 } # Notify
							}
						}
					}
					else_if = {
						limit = {
							NOR = {
								has_building = ca_wall_q_1
								is_building = ca_wall_q_1
							}
							# location = { TECH_FORTIFICATIONS_CONSTRUCTION >= 0 }
						}

						add_building = ca_wall_q_1

						hidden_effect = {
							FROM = {
								character_event = { id = HF.25069 } # Notify
							}
						}
					}
				}
			}
			else_if = {
				limit = { holding_type = tribal }

				if = {
					limit = {
						NOR = {
							has_building = tb_hillfort_4
							is_building = tb_hillfort_4
						}
					}

					if = {
						limit = {
							has_building = tb_hillfort_3
							location = { TECH_CASTLE_CONSTRUCTION >= 1 }
						}

						add_building = tb_hillfort_4

						hidden_effect = {
							FROM = {
								character_event = { id = HF.25067 } # Notify
							}
						}
					}
					else_if = {
						limit = {
							has_building = tb_hillfort_2
							NOT = { is_building = tb_hillfort_3 }
							# location = { TECH_CASTLE_CONSTRUCTION >= 0 }
						}

						add_building = tb_hillfort_3

						hidden_effect = {
							FROM = {
								character_event = { id = HF.25066 } # Notify
							}
						}
					}
					else_if = {
						limit = {
							has_building = tb_hillfort_1
							NOT = { is_building = tb_hillfort_2 }
							# location = { TECH_CASTLE_CONSTRUCTION >= 0 }
						}

						add_building = tb_hillfort_2

						hidden_effect = {
							FROM = {
								character_event = { id = HF.25065 } # Notify
							}
						}
					}
					else_if = {
						limit = {
							NOR = {
								is_building = tb_hillfort_1
								has_building = tb_hillfort_1
							}
							# location = { TECH_CASTLE_CONSTRUCTION >= 0 }
						}

						add_building = tb_hillfort_1

						hidden_effect = {
							FROM = {
								character_event = { id = HF.25064 } # Notify
							}
						}
					}
				}

				else_if = {
					limit = {
						NOR = {
							has_building = tb_defensive_fortifications_4
							is_building = tb_defensive_fortifications_4
						}
					}

					if = {
						limit = {
							has_building = tb_defensive_fortifications_3
							NOT = { is_building = tb_defensive_fortifications_4 }							location = { TECH_CASTLE_CONSTRUCTION >= 1 }
						}

						add_building = tb_defensive_fortifications_4

						hidden_effect = {
							FROM = {
								character_event = { id = HF.25063 } # Notify
							}
						}
					}
					else_if = {
						limit = {
							has_building = tb_defensive_fortifications_2
							NOT = { is_building = tb_defensive_fortifications_3 }
							# location = { TECH_CASTLE_CONSTRUCTION >= 0 }
						}

						add_building = tb_defensive_fortifications_3

						hidden_effect = {
							FROM = {
								character_event = { id = HF.25062 } # Notify
							}
						}
					}
					else_if = {
						limit = {
							has_building = tb_defensive_fortifications_1
							NOT = { is_building = tb_defensive_fortifications_2 }
							# location = { TECH_CASTLE_CONSTRUCTION >= 0 }
						}

						add_building = tb_defensive_fortifications_2

						hidden_effect = {
							FROM = {
								character_event = { id = HF.25061 } # Notify
							}
						}
					}
					else_if = {
						limit = {
							NOR = {
								is_building = tb_defensive_fortifications_1
								has_building = tb_defensive_fortifications_1
							}
							# location = { TECH_CASTLE_CONSTRUCTION >= 0 }
						}

						add_building = tb_defensive_fortifications_1

						hidden_effect = {
							FROM = {
								character_event = { id = HF.25060 } # Notify
							}
						}
					}
				}
			}
		}

		ai_will_do = {
			factor = 1
		}
	}
}